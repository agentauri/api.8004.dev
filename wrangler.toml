# 8004-backend Cloudflare Workers Configuration
# See https://developers.cloudflare.com/workers/wrangler/configuration/

name = "8004-backend"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Development settings
[dev]
port = 8787
local_protocol = "http"

# Environment variables (non-sensitive)
[vars]
ENVIRONMENT = "production"
CACHE_TTL = "300"
RATE_LIMIT_RPM = "100"
# Primary classifier: Google Gemini 2.0 Flash (fast and economical)
CLASSIFICATION_MODEL = "gemini-2.0-flash"
# Fallback classifier: Claude Haiku (reliable backup)
FALLBACK_MODEL = "claude-3-haiku-20240307"
# OAuth 2.0 configuration for MCP authentication (Claude Desktop support)
OAUTH_ISSUER = "https://api.8004.dev"
OAUTH_ACCESS_TOKEN_TTL = "3600"        # 1 hour
OAUTH_REFRESH_TOKEN_TTL = "2592000"    # 30 days
OAUTH_AUTH_CODE_TTL = "600"            # 10 minutes
# x402 Payment Configuration (optional - leave X402_RECEIVER_ADDRESS unset to disable)
# Set receiver address via: wrangler secret put X402_RECEIVER_ADDRESS
X402_NETWORK = "eip155:8453"           # Base Mainnet (CAIP-2 identifier)
X402_FACILITATOR_URL = "https://x402.org/facilitator"

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "8004-backend-db"
database_id = "95baaaa3-ac8a-4f6a-abd1-279dca4e117e"

# KV Namespace binding
[[kv_namespaces]]
binding = "CACHE"
id = "0c79182a35d64c00b29bfef2d0554f71"

# Queue producer binding
[[queues.producers]]
binding = "CLASSIFICATION_QUEUE"
queue = "classification-jobs"

# Queue consumer configuration
[[queues.consumers]]
queue = "classification-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "classification-jobs-dlq"

# Evaluation queue producer binding
[[queues.producers]]
binding = "EVALUATION_QUEUE"
queue = "evaluation-jobs"

# Evaluation queue consumer configuration
[[queues.consumers]]
queue = "evaluation-jobs"
max_batch_size = 5
max_batch_timeout = 60
max_retries = 3
dead_letter_queue = "evaluation-jobs-dlq"

# Scheduled triggers (cron)
[triggers]
crons = [
  "*/15 * * * *",  # Run Qdrant sync every 15 minutes
  "0 * * * *"      # Run EAS indexer + reconciliation every hour
]

# ------------------------------------------------------------------
# Secrets (set via `wrangler secret put <SECRET_NAME>`)
# ------------------------------------------------------------------
# RPC URLs for supported chains:
# Ethereum Mainnet (1):             ETHEREUM_RPC_URL
# Ethereum Sepolia (11155111):      SEPOLIA_RPC_URL
# Base Sepolia (84532):             BASE_SEPOLIA_RPC_URL
# Polygon Amoy (80002):             POLYGON_AMOY_RPC_URL
# Linea Sepolia (59141):            LINEA_SEPOLIA_RPC_URL
# Hedera Testnet (296):             HEDERA_TESTNET_RPC_URL
# HyperEVM Testnet (998):           HYPEREVM_TESTNET_RPC_URL
# SKALE Base Sepolia (1351057110):  SKALE_BASE_SEPOLIA_RPC_URL
#
# x402 Payment:
# X402_RECEIVER_ADDRESS             Wallet address to receive payments (0x...)
#                                   Leave unset to disable x402 payments
# ------------------------------------------------------------------

# Staging environment
[env.staging]
name = "8004-backend-staging"
[env.staging.vars]
ENVIRONMENT = "staging"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "8004-backend-db-staging"
database_id = "placeholder-replace-after-creation"

[[env.staging.kv_namespaces]]
binding = "CACHE"
id = "placeholder-replace-after-creation"

[[env.staging.queues.producers]]
binding = "CLASSIFICATION_QUEUE"
queue = "classification-jobs-staging"

[[env.staging.queues.consumers]]
queue = "classification-jobs-staging"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3

[[env.staging.queues.producers]]
binding = "EVALUATION_QUEUE"
queue = "evaluation-jobs-staging"

[[env.staging.queues.consumers]]
queue = "evaluation-jobs-staging"
max_batch_size = 5
max_batch_timeout = 60
max_retries = 3

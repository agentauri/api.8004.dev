# 8004-backend Cloudflare Workers Configuration
# See https://developers.cloudflare.com/workers/wrangler/configuration/

name = "8004-backend"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Development settings
[dev]
port = 8787
local_protocol = "http"

# Environment variables (non-sensitive)
[vars]
ENVIRONMENT = "production"
CACHE_TTL = "300"
RATE_LIMIT_RPM = "100"
CLASSIFICATION_MODEL = "claude-3-haiku-20240307"

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "8004-backend-db"
database_id = "95baaaa3-ac8a-4f6a-abd1-279dca4e117e"

# KV Namespace binding
[[kv_namespaces]]
binding = "CACHE"
id = "0c79182a35d64c00b29bfef2d0554f71"

# Queue producer binding
[[queues.producers]]
binding = "CLASSIFICATION_QUEUE"
queue = "classification-jobs"

# Queue consumer configuration
[[queues.consumers]]
queue = "classification-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "classification-jobs-dlq"

# Scheduled triggers (cron)
[triggers]
crons = ["0 * * * *"]  # Run EAS indexer every hour

# Staging environment
[env.staging]
name = "8004-backend-staging"
[env.staging.vars]
ENVIRONMENT = "staging"

[[env.staging.d1_databases]]
binding = "DB"
database_name = "8004-backend-db-staging"
database_id = "placeholder-replace-after-creation"

[[env.staging.kv_namespaces]]
binding = "CACHE"
id = "placeholder-replace-after-creation"

[[env.staging.queues.producers]]
binding = "CLASSIFICATION_QUEUE"
queue = "classification-jobs-staging"

[[env.staging.queues.consumers]]
queue = "classification-jobs-staging"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
